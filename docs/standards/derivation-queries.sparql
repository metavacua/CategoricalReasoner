# SPARQL Queries for AGENTS.md Derivation
# These queries extract information from repository-constraints.ttl
# to generate AGENTS.md files in canonical form
#
# Usage: apache-jena/bin/arq --data=repository-constraints.ttl --query=<query>

# ========================================
# QUERY 1: Get Root AGENTS.md Content
# ========================================
# File: get-root-agents.sparql

PREFIX agents: <urn:repo:categoricalreasoner:agents#>
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT ?title ?constraintLabel ?constraintDefinition ?seeAlsoLabel ?seeAlsoPath
WHERE {
  # Get the root node
  agents:RootNode a agents:RepositoryNode .
  
  # Get all core constraints
  ?constraint a skos:Concept ;
              skos:broader* agents:CoreConstraint ;
              skos:prefLabel ?constraintLabel ;
              skos:definition ?constraintDefinition .
  
  # Get See Also references (nodes that derive from root)
  OPTIONAL {
    ?seeAlsoNode agents:derivesFrom agents:RootNode ;
                 rdfs:label ?seeAlsoLabel ;
                 agents:hasAgentsFile ?seeAlsoPath .
  }
}
ORDER BY ?constraintLabel

# ========================================
# QUERY 2: Get Node-Specific Constraints
# ========================================
# File: get-node-constraints.sparql
# Parameter: ?targetNode (e.g., agents:DocsNode, agents:SrcNode)

PREFIX agents: <urn:repo:categoricalreasoner:agents#>
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT ?nodeLabel ?nodePath ?constraintLabel ?constraintDefinition 
       ?license ?derivesFromLabel ?derivesFromPath
WHERE {
  # Target node
  BIND(?targetNode AS ?node)
  
  ?node rdfs:label ?nodeLabel ;
        agents:applicableConstraint ?constraint ;
        agents:hasAgentsFile ?nodePath .
  
  ?constraint skos:prefLabel ?constraintLabel ;
              skos:definition ?constraintDefinition .
  
  # Get license
  OPTIONAL {
    ?node agents:license ?licenseUri .
    BIND(STRAFTER(STR(?licenseUri), "licenses/") AS ?license)
  }
  
  # Get derivation source
  OPTIONAL {
    ?node agents:derivesFrom ?derivesFrom .
    ?derivesFrom rdfs:label ?derivesFromLabel ;
                 agents:hasAgentsFile ?derivesFromPath .
  }
}
ORDER BY ?constraintLabel

# ========================================
# QUERY 3: Get Repository Hierarchy
# ========================================
# File: get-hierarchy.sparql

PREFIX agents: <urn:repo:categoricalreasoner:agents#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT ?nodeLabel ?nodePath ?parentLabel ?parentPath
WHERE {
  ?node a agents:RepositoryNode ;
        rdfs:label ?nodeLabel ;
        agents:hasAgentsFile ?nodePath .
  
  OPTIONAL {
    ?parent agents:contains ?node ;
            rdfs:label ?parentLabel ;
            agents:hasAgentsFile ?parentPath .
  }
  
  OPTIONAL {
    ?node agents:derivesFrom ?derivesFromNode .
    ?derivesFromNode rdfs:label ?derivesFromLabel .
  }
}
ORDER BY ?nodePath

# ========================================
# QUERY 4: Get Subdirectories of a Node
# ========================================
# File: get-subdirectories.sparql

PREFIX agents: <urn:repo:categoricalreasoner:agents#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT ?subdirLabel ?subdirPath
WHERE {
  ?parent agents:contains ?subdir .
  ?subdir rdfs:label ?subdirLabel ;
          agents:hasAgentsFile ?subdirPath .
}
ORDER BY ?subdirLabel

# ========================================
# QUERY 5: Validate Derivation Chain
# ========================================
# File: validate-derivation.sparql
# Returns nodes that don't derive from root (violation)

PREFIX agents: <urn:repo:categoricalreasoner:agents#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT ?nodeLabel ?derivesFromLabel
WHERE {
  ?node a agents:RepositoryNode ;
        rdfs:label ?nodeLabel .
  
  FILTER(?node != agents:RootNode)
  
  OPTIONAL {
    ?node agents:derivesFrom ?derivesFrom .
    ?derivesFrom rdfs:label ?derivesFromLabel .
  }
  
  FILTER(!BOUND(?derivesFrom) || ?derivesFrom != agents:RootNode)
}

# ========================================
# QUERY 6: Get All Applicable Constraints for Node
# ========================================
# File: get-all-constraints.sparql

PREFIX agents: <urn:repo:categoricalreasoner:agents#>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX dcterms: <http://purl.org/dc/terms/>

CONSTRUCT {
  ?constraint skos:prefLabel ?label .
  ?constraint skos:definition ?definition .
  ?constraint skos:scopeNote ?scopeNote .
  ?constraint dcterms:relation ?relation .
}
WHERE {
  ?node agents:applicableConstraint ?constraint .
  ?constraint skos:prefLabel ?label ;
              skos:definition ?definition .
  OPTIONAL { ?constraint skos:scopeNote ?scopeNote . }
  OPTIONAL { ?constraint dcterms:relation ?relation . }
}
