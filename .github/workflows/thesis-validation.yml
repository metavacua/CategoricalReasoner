name: Thesis Validation

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml rdflib pyshacl

    - name: Validate TeX structure
      run: |
        python schema/validators/validate_tex_structure.py --tex-dir thesis/chapters/
      continue-on-error: false

    - name: Validate citations
      run: |
        python schema/validators/validate_citations.py --tex-dir thesis/chapters/ --bibliography bibliography/citations.yaml --ontology ontology/citations.jsonld
      continue-on-error: false

    - name: Validate RDF
      run: |
        python schema/validators/validate_rdf.py --ontology ontology/ --shapes ontology/catty-thesis-shapes.shacl
      continue-on-error: false

    - name: Validate bidirectional consistency
      run: |
        python schema/validators/validate_consistency.py --tex-dir thesis/chapters/ --ontology ontology/ --bibliography bibliography/citations.yaml --mapping schema/tex-rdf-mapping.yaml
      continue-on-error: false

    - name: Comment validation results on PR
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const comment = `❌ **Thesis Validation FAILED**

          **Status**: The pull request has validation failures and cannot be merged.

          **Validation Results**:
          - ❌ TeX structure validation: FAILED
          - ❌ Citation validation: FAILED  
          - ❌ RDF/SHACL validation: FAILED
          - ❌ Bidirectional consistency validation: FAILED

          **Action Required**: Please fix the validation errors and push again.

          **Run validation locally**:
          \`\`\`bash
          cd thesis && make clean && make
          python schema/validators/validate_tex_structure.py --tex-dir thesis/chapters/
          python schema/validators/validate_citations.py --tex-dir thesis/chapters/ --bibliography bibliography/citations.yaml --ontology ontology/citations.jsonld
          python schema/validators/validate_rdf.py --ontology ontology/ --shapes ontology/catty-thesis-shapes.shacl
          python schema/validators/validate_consistency.py --tex-dir thesis/chapters/ --ontology ontology/ --bibliography bibliography/citations.yaml --mapping schema/tex-rdf-mapping.yaml
          \`\`\`

          **Exit Codes**: 0=PASS, 1=FAIL, 2=ERROR`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          })

    - name: Comment success on PR
      if: success() && github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const comment = `✅ **Thesis Validation PASSED**

          **Status**: All validation checks passed successfully.

          **Validation Results**:
          - ✅ TeX structure validation: PASSED
          - ✅ Citation validation: PASSED
          - ✅ RDF/SHACL validation: PASSED
          - ✅ Bidirectional consistency validation: PASSED

          **Exit Codes**: 0=PASS, 1=FAIL, 2=ERROR

          This PR is ready for review and merge.`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          })
