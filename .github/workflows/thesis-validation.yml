name: Thesis Validation

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml rdflib pyshacl

    - name: Validate TeX structure
      id: validate_tex
      run: |
        python schema/validators/validate_tex_structure.py --tex-dir thesis/chapters/
        echo "result=success" >> $GITHUB_OUTPUT
      continue-on-error: false

    - name: Validate citations
      id: validate_citations
      run: |
        python schema/validators/validate_citations.py --tex-dir thesis/chapters/ --bibliography bibliography/citations.yaml --ontology ontology/citations.jsonld
        echo "result=success" >> $GITHUB_OUTPUT
      continue-on-error: false

    - name: Validate RDF
      id: validate_rdf
      run: |
        python schema/validators/validate_rdf.py --ontology ontology/ --shapes ontology/catty-thesis-shapes.shacl
        echo "result=success" >> $GITHUB_OUTPUT
      continue-on-error: false

    - name: Validate bidirectional consistency
      id: validate_consistency
      run: |
        python schema/validators/validate_consistency.py --tex-dir thesis/chapters/ --ontology ontology/ --bibliography bibliography/citations.yaml --mapping schema/tex-rdf-mapping.yaml
        echo "result=success" >> $GITHUB_OUTPUT
      continue-on-error: false

    - name: Comment validation results on PR
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const comment = `‚ùå **Thesis Validation Failed**

          **Status**: The pull request has validation failures and cannot be merged.

          **Validation Results**:
          - ‚ùå TeX structure validation: FAILED
          - ‚ùå Citation validation: FAILED
          - ‚ùå RDF/SHACL validation: FAILED
          - ‚ùå Bidirectional consistency validation: FAILED

          **Action Required**: Please fix the validation errors and push again.

          **To run validation locally**:
          \`\`\`bash
          cd thesis && python schema/validators/validate_tex_structure.py --tex-dir thesis/chapters/ && python schema/validators/validate_citations.py --tex-dir thesis/chapters/ --bibliography bibliography/citations.yaml --ontology ontology/citations.jsonld && python schema/validators/validate_rdf.py --ontology ontology/ --shapes ontology/catty-thesis-shapes.shacl && python schema/validators/validate_consistency.py --tex-dir thesis/chapters/ --ontology ontology/ --bibliography bibliography/citations.yaml --mapping schema/tex-rdf-mapping.yaml
          \`\`\`
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          })

    - name: Comment success on PR
      if: success() && github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const comment = `‚úÖ **Thesis Validation Passed**

          **Status**: All validation checks passed successfully.

          **Validation Results**:
          - ‚úÖ TeX structure validation: PASSED
          - ‚úÖ Citation validation: PASSED
          - ‚úÖ RDF/SHACL validation: PASSED
          - ‚úÖ Bidirectional consistency validation: PASSED

          This PR is ready for review and merge.`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          })

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml rdflib pyshacl

    - name: Install LaTeX
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          texlive-latex-base \
          texlive-latex-extra \
          texlive-fonts-recommended \
          biber \
          latexmk

    - name: Build thesis PDF
      run: |
        cd thesis
        make clean
        make all
        
    - name: Upload thesis PDF as artifact
      uses: actions/upload-artifact@v3
      with:
        name: thesis-pdf
        path: thesis/main.pdf
        retention-days: 30

    - name: Deploy thesis (placeholder for actual deployment)
      run: |
        echo "üöÄ All validations passed! Thesis PDF built successfully."
        echo "Add your deployment logic here (e.g., deploying to website, etc.)"
        # Example deployment steps you might want to add:
        # - Deploy to GitHub Pages
        # - Upload to academic repository
        # - Deploy to web server
        # - Send to printer service
        # - Archive in institutional repository
        
    - name: Comment deployment success on PR
      if: success() && github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const comment = `üöÄ **Thesis Deployment Successful**

          **Status**: All validations passed and thesis PDF has been built successfully.

          **Deployment Details**:
          - ‚úÖ All validation checks passed
          - ‚úÖ Thesis PDF generated (available as artifact)
          - ‚úÖ Ready for final deployment/production use

          **Next Steps**: The built PDF can now be:
          - Deployed to GitHub Pages
          - Uploaded to academic repositories
          - Submitted to institutional repositories
          - Distributed to advisors/committee members

          This PR has been validated and deployed successfully!`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          })
