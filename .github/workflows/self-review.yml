name: Self Review Bot

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write

jobs:
  request-changes:
    runs-on: ubuntu-latest
    steps:
      - name: Post self-review
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            const { data: reviews } = await github.rest.pulls.listReviews({ owner, repo, pull_number: number });
            const alreadyRequested = reviews.some(review => review.user.login === 'github-actions[bot]' && review.state === 'CHANGES_REQUESTED');
            if (alreadyRequested) {
              core.info('Self-review already requested changes.');
              return;
            }
            await github.rest.pulls.createReview({
              owner,
              repo,
              pull_number: number,
              event: 'REQUEST_CHANGES',
              body: 'I cannot approve this PR until required checks and policy gates are satisfied.'
            });
